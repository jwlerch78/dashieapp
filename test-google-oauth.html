<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .status {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }
        .status h3 {
            margin-top: 0;
            color: #5f6368;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e8eaed;
        }
        .info-label {
            font-weight: 500;
            color: #5f6368;
        }
        .info-value {
            color: #202124;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #1557b0;
        }
        button:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }
        .success { color: #0f9d58; }
        .error { color: #d93025; }
        .warning { color: #f9ab00; }
        .log {
            background: #202124;
            color: #e8eaed;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #e8f0fe;
            border-radius: 4px;
            margin: 15px 0;
        }
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }
        .user-details {
            flex: 1;
        }
        .user-name {
            font-weight: 500;
            color: #202124;
        }
        .user-email {
            font-size: 13px;
            color: #5f6368;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Google OAuth Flow Test</h1>
        <p>Test the complete OAuth flow: GoogleAccountAuth + WebOAuthProvider + TokenStore</p>

        <div class="status">
            <h3>Authentication Status</h3>
            <div class="info-row">
                <span class="info-label">OAuth Provider:</span>
                <span class="info-value" id="provider-status">Not initialized</span>
            </div>
            <div class="info-row">
                <span class="info-label">Account Auth:</span>
                <span class="info-value" id="auth-status">Not initialized</span>
            </div>
            <div class="info-row">
                <span class="info-label">Token Store:</span>
                <span class="info-value" id="tokenstore-status">Not initialized</span>
            </div>
            <div class="info-row">
                <span class="info-label">User Authenticated:</span>
                <span class="info-value" id="user-auth-status">No</span>
            </div>
        </div>

        <div id="user-info-container"></div>

        <div>
            <button id="btn-init">Initialize System</button>
            <button id="btn-signin" disabled>Sign In with Google</button>
            <button id="btn-signout" disabled>Sign Out</button>
            <button id="btn-check-tokens">Check Stored Tokens</button>
            <button id="btn-clear-log">Clear Log</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { TokenStore } from './js/data/auth/token-store.js';
        import { GoogleAccountAuth } from './js/data/auth/account-auth/google-account-auth.js';
        import { WebOAuthProvider } from './js/data/auth/providers/web-oauth.js';

        // Global references
        let tokenStore = null;
        let webOAuthProvider = null;
        let googleAccountAuth = null;

        // Logging
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#e8eaed',
                success: '#81c995',
                error: '#f28b82',
                warning: '#fdd663'
            };
            const color = colors[type] || colors.info;
            logEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(element, value, isSuccess = true) {
            const el = document.getElementById(element);
            el.textContent = value;
            el.className = 'info-value ' + (isSuccess ? 'success' : 'error');
        }

        function showUserInfo(user) {
            const container = document.getElementById('user-info-container');
            container.innerHTML = `
                <div class="user-info">
                    <img src="${user.picture || 'https://via.placeholder.com/48'}"
                         alt="${user.name}"
                         class="user-avatar">
                    <div class="user-details">
                        <div class="user-name">${user.name}</div>
                        <div class="user-email">${user.email}</div>
                    </div>
                </div>
            `;
        }

        function hideUserInfo() {
            document.getElementById('user-info-container').innerHTML = '';
        }

        // Initialize system
        async function initializeSystem() {
            try {
                log('üöÄ Initializing authentication system...', 'info');

                // 1. Initialize TokenStore
                log('1Ô∏è‚É£ Initializing TokenStore...', 'info');
                tokenStore = new TokenStore();
                await tokenStore.initialize();
                updateStatus('tokenstore-status', 'Ready ‚úì', true);
                log('   ‚úÖ TokenStore ready', 'success');

                // 2. Initialize WebOAuthProvider
                log('2Ô∏è‚É£ Initializing WebOAuthProvider...', 'info');
                webOAuthProvider = new WebOAuthProvider();
                const oauthResult = await webOAuthProvider.init();
                updateStatus('provider-status', 'Ready ‚úì', true);
                log('   ‚úÖ WebOAuthProvider ready', 'success');

                // 3. Initialize GoogleAccountAuth
                log('3Ô∏è‚É£ Initializing GoogleAccountAuth...', 'info');
                googleAccountAuth = new GoogleAccountAuth(webOAuthProvider, null);
                await googleAccountAuth.initialize();
                updateStatus('auth-status', 'Ready ‚úì', true);
                log('   ‚úÖ GoogleAccountAuth ready', 'success');

                // 4. Check if OAuth callback returned a user
                if (oauthResult && oauthResult.success && oauthResult.user) {
                    log('üéâ OAuth callback detected! User authenticated during init', 'success');

                    // Store tokens
                    const tokenData = {
                        access_token: oauthResult.tokens.access_token,
                        refresh_token: oauthResult.tokens.refresh_token,
                        expires_at: new Date(Date.now() + (oauthResult.tokens.expires_in * 1000)).toISOString(),
                        scopes: oauthResult.tokens.scope?.split(' ') || [],
                        email: oauthResult.user.email,
                        display_name: oauthResult.user.name
                    };

                    await tokenStore.storeAccountTokens('google', 'primary', tokenData);
                    log('   ‚úÖ Tokens stored in TokenStore', 'success');

                    // Show user info
                    showUserInfo(oauthResult.user);
                    updateStatus('user-auth-status', `Yes - ${oauthResult.user.email}`, true);

                    document.getElementById('btn-signout').disabled = false;
                    document.getElementById('btn-signin').disabled = true;
                } else {
                    // Check if user was previously authenticated
                    if (googleAccountAuth.isAuthenticated()) {
                        const user = googleAccountAuth.getUser();
                        log('‚úÖ User session restored from previous login', 'success');
                        showUserInfo(user);
                        updateStatus('user-auth-status', `Yes - ${user.email}`, true);
                        document.getElementById('btn-signout').disabled = false;
                        document.getElementById('btn-signin').disabled = true;
                    } else {
                        log('‚ÑπÔ∏è No user authenticated. Click "Sign In with Google" to start.', 'info');
                        document.getElementById('btn-signin').disabled = false;
                    }
                }

                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('‚úÖ System initialization complete!', 'success');

            } catch (error) {
                log(`‚ùå Initialization error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Sign in
        async function signIn() {
            try {
                log('üîê Starting Google sign-in flow...', 'info');
                await googleAccountAuth.signIn();
                // Note: This will redirect to Google, so code after this won't run
            } catch (error) {
                log(`‚ùå Sign-in error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Sign out
        async function signOut() {
            try {
                log('üëã Signing out...', 'info');
                await googleAccountAuth.signOut();
                await tokenStore.clearAllTokens();

                hideUserInfo();
                updateStatus('user-auth-status', 'No', false);

                document.getElementById('btn-signin').disabled = false;
                document.getElementById('btn-signout').disabled = true;

                log('‚úÖ Signed out successfully', 'success');
            } catch (error) {
                log(`‚ùå Sign-out error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Check tokens
        async function checkTokens() {
            try {
                log('üîç Checking stored tokens...', 'info');

                if (!tokenStore) {
                    log('‚ö†Ô∏è TokenStore not initialized', 'warning');
                    return;
                }

                const allTokens = await tokenStore.getAllTokens();
                const accounts = tokenStore.listAllAccounts();

                if (accounts.length === 0) {
                    log('‚ÑπÔ∏è No tokens stored', 'info');
                } else {
                    log(`üì¶ Found ${accounts.length} account(s):`, 'info');
                    accounts.forEach((acc, i) => {
                        log(`   ${i + 1}. ${acc.provider}/${acc.accountType}`, 'info');
                        log(`      Email: ${acc.email}`, 'info');
                        log(`      Display Name: ${acc.display_name}`, 'info');
                        log(`      Active: ${acc.is_active}`, 'info');
                    });
                }

                // Check if token is expired
                const googleTokens = await tokenStore.getAccountTokens('google', 'primary');
                if (googleTokens) {
                    if (googleTokens.isExpired) {
                        log('‚ö†Ô∏è Token is expired', 'warning');
                    } else {
                        log('‚úÖ Token is valid', 'success');
                    }
                }

            } catch (error) {
                log(`‚ùå Error checking tokens: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Button handlers
        document.getElementById('btn-init').addEventListener('click', initializeSystem);
        document.getElementById('btn-signin').addEventListener('click', signIn);
        document.getElementById('btn-signout').addEventListener('click', signOut);
        document.getElementById('btn-check-tokens').addEventListener('click', checkTokens);
        document.getElementById('btn-clear-log').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // Auto-initialize on page load
        log('üëã Page loaded. Click "Initialize System" to begin.', 'info');
    </script>
</body>
</html>
