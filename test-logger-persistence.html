<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logger Persistence Test</title>
  <style>
    body {
      font-family: system-ui;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
    }
    .success { color: green; }
    .error { color: red; }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîç Logger Persistence Test</h1>
  
  <div class="test-section">
    <h2>Log Buffer Management</h2>
    <pre id="buffer-info"></pre>
    <button onclick="viewBuffer()">View Buffer</button>
    <button onclick="saveToFile()">üíæ Save Logs to File</button>
    <button onclick="clearBuffer()">üóëÔ∏è Clear Buffer</button>
    <div id="save-result"></div>
  </div>

  <div class="test-section">
    <h2>Current Configuration</h2>
    <pre id="current-config"></pre>
    <button onclick="refreshConfig()">Refresh Config</button>
  </div>

  <div class="test-section">
    <h2>Change Log Level</h2>
    <button onclick="setLevel('DEBUG')">Set to DEBUG (0)</button>
    <button onclick="setLevel('INFO')">Set to INFO (1)</button>
    <button onclick="setLevel('WARN')">Set to WARN (2)</button>
    <button onclick="setLevel('ERROR')">Set to ERROR (3)</button>
    <button onclick="setLevel('SILENT')">Set to SILENT (4)</button>
  </div>

  <div class="test-section">
    <h2>Toggle Categories</h2>
    <button onclick="toggleCategory('enableApiLogging')">Toggle API Logging</button>
    <button onclick="toggleCategory('enableAuthLogging')">Toggle Auth Logging</button>
    <button onclick="toggleCategory('enableDataLogging')">Toggle Data Logging</button>
    <button onclick="toggleCategory('enableWidgetLogging')">Toggle Widget Logging</button>
  </div>

  <div class="test-section">
    <h2>LocalStorage Check</h2>
    <pre id="localStorage-value"></pre>
    <button onclick="checkLocalStorage()">Check localStorage</button>
    <button onclick="clearStorage()">Clear Storage</button>
  </div>

  <div class="test-section">
    <h2>Test Logs</h2>
    <button onclick="testLogs()">Generate Test Logs</button>
    <p><em>Check browser console to see the logs</em></p>
  </div>

  <div id="status"></div>

  <script type="module">
    import { getLoggingConfig, configureLogging, createLogger, LOG_LEVELS, getLogBuffer, clearLogBuffer, saveLogsToFile } from './js/utils/logger.js';
    
    // Make functions globally available for buttons
    window.testLogger = createLogger('TEST');
    window.getLoggingConfig = getLoggingConfig;
    window.configureLogging = configureLogging;
    window.LOG_LEVELS = LOG_LEVELS;

    window.refreshConfig = function() {
      const config = getLoggingConfig();
      document.getElementById('current-config').textContent = JSON.stringify(config, null, 2);
    };

    window.setLevel = function(levelName) {
      const level = LOG_LEVELS[levelName];
      configureLogging({ level });
      showStatus(`‚úÖ Log level set to ${levelName} (${level})`, 'success');
      refreshConfig();
      checkLocalStorage();
    };

    window.toggleCategory = function(category) {
      const current = getLoggingConfig();
      const newValue = !current[category];
      configureLogging({ [category]: newValue });
      showStatus(`‚úÖ ${category} set to ${newValue}`, 'success');
      refreshConfig();
      checkLocalStorage();
    };

    window.checkLocalStorage = function() {
      const stored = localStorage.getItem('dashie-log-config');
      const display = document.getElementById('localStorage-value');
      if (stored) {
        display.textContent = JSON.stringify(JSON.parse(stored), null, 2);
        display.style.color = 'green';
      } else {
        display.textContent = 'null (no config saved yet)';
        display.style.color = 'orange';
      }
    };

    window.clearStorage = function() {
      localStorage.removeItem('dashie-log-config');
      showStatus('‚ö†Ô∏è LocalStorage cleared', 'error');
      checkLocalStorage();
    };

    window.testLogs = function() {
      window.testLogger.debug('This is a DEBUG message');
      window.testLogger.info('This is an INFO message');
      window.testLogger.warn('This is a WARN message');
      window.testLogger.error('This is an ERROR message');
      window.testLogger.success('This is a SUCCESS message');
      showStatus('‚úÖ Test logs generated - check console', 'success');
      updateBufferInfo();
    };

    window.viewBuffer = function() {
      const buffer = getLogBuffer();
      console.log('Current Log Buffer:', buffer);
      showStatus(`üìã Buffer has ${buffer.length} entries - check console`, 'success');
    };

    window.saveToFile = async function() {
      const saveBtn = event.target;
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        const result = await saveLogsToFile();
        const resultDiv = document.getElementById('save-result');
        
        if (result.success) {
          resultDiv.innerHTML = `<p class="success">‚úÖ ${result.message}</p>`;
          if (result.filepath) {
            resultDiv.innerHTML += `<p><em>File: ${result.filepath}</em></p>`;
          }
        } else {
          resultDiv.innerHTML = `<p class="error">‚ùå Failed: ${result.error}</p>`;
        }
        
        setTimeout(() => resultDiv.innerHTML = '', 5000);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Logs to File';
      }
    };

    window.clearBuffer = function() {
      if (confirm('Are you sure you want to clear the log buffer?')) {
        clearLogBuffer();
        showStatus('üóëÔ∏è Log buffer cleared', 'success');
        updateBufferInfo();
      }
    };

    function updateBufferInfo() {
      const buffer = getLogBuffer();
      const info = document.getElementById('buffer-info');
      info.textContent = `Buffer Size: ${buffer.length} / ${200} entries (auto-trimmed if localStorage full)`;
      if (buffer.length > 0) {
        const oldest = new Date(buffer[0].timestamp).toLocaleString();
        const newest = new Date(buffer[buffer.length - 1].timestamp).toLocaleString();
        info.textContent += `\nOldest: ${oldest}\nNewest: ${newest}`;
      }
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.innerHTML = `<p class="${type}">${message}</p>`;
      setTimeout(() => status.innerHTML = '', 3000);
    }

    // Initial display - call after functions are defined
    window.refreshConfig();
    window.checkLocalStorage();
    updateBufferInfo();

    // Auto-refresh every 2 seconds
    setInterval(() => {
      window.refreshConfig();
      window.checkLocalStorage();
      updateBufferInfo();
    }, 2000);
  </script>
</body>
</html>
