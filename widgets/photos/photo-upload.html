<!-- Photo-upload.html -->

<!DOCTYPE html>
<!-- CHANGE SUMMARY: Removed folder selector UI, added album parameter via postMessage, auto-triggers file picker on init -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Photos</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      color: #1a1a1a;
      overflow: hidden;
    }

    .upload-container {
      width: 100%;
      max-width: 500px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .upload-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid #e0e0e0;
      background: #f8f9fa;
    }

    .upload-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      flex: 1;
      text-align: center;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .close-button:hover,
    .close-button:focus {
      background: rgba(0, 0, 0, 0.05);
      outline: 2px solid #ff6b35;
      outline-offset: 2px;
    }

    .upload-body {
      padding: 24px;
    }

    .upload-section {
      margin-bottom: 24px;
    }

    .album-display {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 24px;
    }

    .album-display-label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
    }

    .album-display-value {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .progress-section {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }

    .progress-section.active {
      display: block;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
      transition: width 0.3s ease;
      border-radius: 4px;
      width: 0%;
    }

    .progress-detail {
      font-size: 12px;
      color: #666;
      margin: 0;
    }

    .storage-section {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
    }

    .storage-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .storage-label {
      color: #666;
    }

    .storage-value {
      color: #333;
      font-weight: 600;
    }

    .storage-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }

    .storage-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
      transition: width 0.3s ease, background 0.3s ease;
      border-radius: 3px;
      width: 0%;
    }

    .storage-fill.warning {
      background: linear-gradient(90deg, #ff9800 0%, #ff5722 100%);
    }

    .error-message {
      background: #ffebee;
      border: 1px solid #ef5350;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* Dark theme */
    body.theme-dark {
      color: #e0e0e0;
    }

    body.theme-dark .upload-container {
      background: #1a1a1a;
    }

    body.theme-dark .upload-header {
      background: #2a2a2a;
      border-bottom-color: #3a3a3a;
    }

    body.theme-dark .close-button {
      color: #e0e0e0;
    }

    body.theme-dark .close-button:hover,
    body.theme-dark .close-button:focus {
      background: rgba(255, 255, 255, 0.1);
    }

    body.theme-dark .album-display {
      background: #2a2a2a;
    }

    body.theme-dark .album-display-label {
      color: #999;
    }

    body.theme-dark .album-display-value {
      color: #e0e0e0;
    }

    body.theme-dark .progress-section,
    body.theme-dark .storage-section {
      background: #2a2a2a;
    }

    body.theme-dark .progress-info,
    body.theme-dark .storage-value {
      color: #e0e0e0;
    }

    body.theme-dark .progress-detail,
    body.theme-dark .storage-label {
      color: #999;
    }
  </style>
</head>
<body>
  <div class="upload-container">
    <div class="upload-header">
      <div style="width: 32px;"></div>
      <h2>Upload Photos</h2>
      <button class="close-button" id="close-button" aria-label="Close">Ã—</button>
    </div>
    
    <div class="upload-body">
      <!-- Error Display -->
      <div id="error-container"></div>

      <!-- Album Display -->
      <div class="album-display">
        <span class="album-display-label">Uploading to:</span>
        <span class="album-display-value" id="album-display">All Photos</span>
      </div>

      <!-- Progress Display -->
      <div class="progress-section" id="progress-section">
        <div class="progress-info">
          <span class="progress-text">Uploading...</span>
          <span class="progress-percentage" id="progress-percentage">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p class="progress-detail" id="progress-detail">Photo 0 of 0</p>
      </div>

      <!-- Storage Info -->
      <div class="storage-section">
        <div class="storage-info">
          <span class="storage-label">Storage Used:</span>
          <span class="storage-value" id="storage-value">Loading...</span>
        </div>
        <div class="storage-bar">
          <div class="storage-fill" id="storage-fill"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { PhotoStorageService } from '../../js/supabase/photo-storage-service.js';
    import { createLogger } from '../../js/utils/logger.js';

    const logger = createLogger('PhotoUploadModal');

    class PhotoUploadModal {
      constructor() {
        this.userId = null;
        this.storage = null;
        this.selectedAlbum = 'all-photos';
        this.isUploading = false;
        this.isReady = false;

        // Get DOM elements
        this.albumDisplay = document.getElementById('album-display');
        this.closeBtn = document.getElementById('close-button');
        this.progressSection = document.getElementById('progress-section');
        this.progressFill = document.getElementById('progress-fill');
        this.progressPercentage = document.getElementById('progress-percentage');
        this.progressDetail = document.getElementById('progress-detail');
        this.storageValue = document.getElementById('storage-value');
        this.storageFill = document.getElementById('storage-fill');
        this.errorContainer = document.getElementById('error-container');

        logger.info('PhotoUploadModal initializing');
        this.setupEventListeners();
        
        // Signal ready and request initialization data
        this.signalReady();
      }

      signalReady() {
        logger.debug('Signaling iframe ready to parent');
        if (window.parent !== window) {
          window.parent.postMessage({
            type: 'upload-modal-ready',
            source: 'photo-upload'
          }, '*');
        }
      }

      setupEventListeners() {
        // Close button
        this.closeBtn.addEventListener('click', () => this.close());

        // Listen for initialization data from parent
        window.addEventListener('message', (event) => {
          if (event.data?.type === 'init-upload-modal' && event.data.userId) {
            logger.info('Received initialization data from parent', { 
              userId: event.data.userId,
              album: event.data.album 
            });
            this.initialize(event.data.userId, event.data.theme, event.data.album);
          } else if (event.data?.type === 'theme-change') {
            this.applyTheme(event.data.theme);
          }
        });

        logger.debug('Event listeners attached');
      }

      async initialize(userId, theme, album = 'all-photos') {
        this.userId = userId;
        this.selectedAlbum = album;
        
        if (!this.userId) {
          this.showError('User ID not provided. Please close and try again.');
          logger.error('No userId provided in initialization');
          return;
        }

        logger.info('Initializing with userId', { userId: this.userId, album: this.selectedAlbum });

        // Update album display
        this.albumDisplay.textContent = this.selectedAlbum === 'all-photos' ? 'All Photos' : this.selectedAlbum;

        // Get JWT service from parent window
        const jwtService = window.parent?.jwtAuth;
        
        if (!jwtService) {
          logger.warn('No JWT service available from parent window');
        }

        try {
          // Initialize storage service
          this.storage = new PhotoStorageService(this.userId, jwtService);
          logger.info('PhotoStorageService initialized');

          // Update storage display
          await this.updateStorageDisplay();

          // Apply theme
          if (theme) {
            this.applyTheme(theme);
          }

          this.isReady = true;
          logger.success('PhotoUploadModal initialized successfully');

          // Auto-open file picker after initialization
          setTimeout(() => {
            this.openFilePicker();
          }, 300);

        } catch (error) {
          this.showError('Failed to initialize upload modal: ' + error.message);
          logger.error('Initialization failed', error);
        }
      }

      showError(message) {
        this.errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      }

      clearError() {
        this.errorContainer.innerHTML = '';
      }

      async updateStorageDisplay() {
        try {
          const usage = await this.storage.getStorageUsage();
          
          this.storageValue.textContent = `${usage.usedMB} MB / ${usage.quotaGB} GB`;
          this.storageFill.style.width = `${usage.percentUsed}%`;

          // Add warning color if over 80%
          if (usage.percentUsed > 80) {
            this.storageFill.classList.add('warning');
          } else {
            this.storageFill.classList.remove('warning');
          }

          logger.debug('Storage display updated', usage);
        } catch (error) {
          logger.error('Failed to update storage display', error);
          this.storageValue.textContent = 'Error loading storage';
        }
      }

      openFilePicker() {
        if (this.isUploading) {
          logger.warn('Upload already in progress');
          return;
        }

        if (!this.isReady) {
          this.showError('Upload modal not ready. Please wait...');
          return;
        }

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.multiple = true;

        input.onchange = async (e) => {
          const files = Array.from(e.target.files);
          if (files.length > 0) {
            await this.handleUpload(files);
          } else {
            // User cancelled - close modal
            this.close();
          }
        };

        // Handle cancel (user closes picker without selecting)
        input.oncancel = () => {
          logger.info('File picker cancelled by user');
          this.close();
        };

        input.click();
      }

      async handleUpload(files) {
        this.clearError();
        
        logger.info('Starting upload', { fileCount: files.length, album: this.selectedAlbum });

        this.isUploading = true;
        this.progressSection.classList.add('active');

        try {
          // Upload with progress callback
          const results = await this.storage.uploadPhotos(files, this.selectedAlbum, (percent, filename, current, total) => {
            this.progressFill.style.width = `${percent}%`;
            this.progressPercentage.textContent = `${percent}%`;
            this.progressDetail.textContent = `Photo ${current} of ${total}: ${filename}`;
            logger.debug('Upload progress', { percent, filename, current, total });
          });

          // Check results
          const successCount = results.filter(r => r.success).length;
          const failCount = results.length - successCount;

          logger.info('Upload complete', { 
            total: results.length, 
            successful: successCount, 
            failed: failCount 
          });

          // Show results
          if (failCount > 0) {
            const failures = results.filter(r => !r.success);
            logger.error('Some uploads failed', { failures });
            this.showError(`Upload complete: ${successCount} succeeded, ${failCount} failed.`);
          }

          // Update storage display
          await this.updateStorageDisplay();

          // Notify parent that photos were uploaded
          if (window.parent !== window) {
            window.parent.postMessage({
              type: 'photos-uploaded',
              count: successCount
            }, '*');
          }

          // Close modal after successful upload (with small delay to show completion)
          if (successCount > 0) {
            setTimeout(() => {
              this.close();
            }, 1500);
          }

        } catch (error) {
          logger.error('Upload failed', error);
          this.showError('Upload failed: ' + error.message);
        } finally {
          this.isUploading = false;
        }
      }

      applyTheme(theme) {
        if (theme === 'dark') {
          document.body.classList.add('theme-dark');
        } else {
          document.body.classList.remove('theme-dark');
        }
        logger.debug('Theme applied', { theme });
      }

      close() {
        logger.info('Closing upload modal');
        if (window.parent !== window) {
          window.parent.postMessage({
            type: 'close-upload-modal'
          }, '*');
        }
      }
    }

    // Initialize modal
    const modal = new PhotoUploadModal();
  </script>
</body>
</html>