<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashie Dashboard</title>

  <!-- Dashboard Module CSS -->
  <link rel="stylesheet" href="./css/modules/dashboard.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #1a1a1a;
      color: #ffffff;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* OAuth Login Screen */
    #oauth-login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.3s ease;
    }

    #oauth-login-screen.hidden {
      display: none; /* Actually remove from layout */
    }

    .login-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 48px;
      max-width: 450px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .login-logo {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .login-title {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #fff;
    }

    .login-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 32px;
    }

    .login-status {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    .login-button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .login-button:hover {
      background: #1557b0;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    .login-button:disabled {
      background: rgba(255, 255, 255, 0.1);
      cursor: not-allowed;
      transform: none;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .login-error {
      background: rgba(217, 48, 37, 0.1);
      border: 1px solid rgba(217, 48, 37, 0.3);
      color: #f28b82;
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
    }

    .dashboard-container {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .dashboard-container.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- OAuth Login Screen -->
  <div id="oauth-login-screen">
    <div class="login-container">
      <div class="login-logo">üéØ</div>
      <h1 class="login-title">Dashie</h1>
      <p class="login-subtitle">Your Personal Dashboard</p>

      <div class="login-status" id="login-status">
        Initializing authentication system...
      </div>

      <button class="login-button" id="login-button" disabled>
        <span class="spinner"></span>
        <span>Loading...</span>
      </button>

      <div class="login-error" id="login-error" style="display: none;"></div>
    </div>
  </div>

  <!-- Dashboard Container (hidden until authenticated) -->
  <div id="dashboard-container" class="dashboard-container">
    <!-- Dashboard renders here full-screen -->
  </div>

  <!-- Core JavaScript Modules -->
  <script type="module">
    import { createLogger } from './js/utils/logger.js';
    import consoleCommands from './js/utils/console-commands.js';
    import AppComms from './js/core/app-comms.js';
    import AppStateManager from './js/core/app-state-manager.js';
    import InputHandler from './js/core/input-handler.js';
    import ActionRouter from './js/core/action-router.js';
    import WidgetMessenger from './js/core/widget-messenger.js';
    import { getPlatformDetector } from './js/utils/platform-detector.js';
    import Dashboard from './js/modules/Dashboard/dashboard.js';
    import DashboardInputHandler from './js/modules/Dashboard/dashboard-input-handler.js';

    // Phase 3 - Auth imports
    import { TokenStore } from './js/data/auth/token-store.js';
    import { EdgeClient } from './js/data/auth/edge-client.js';
    import { GoogleAccountAuth } from './js/data/auth/account-auth/google-account-auth.js';
    import { WebOAuthProvider } from './js/data/auth/providers/web-oauth.js';
    import { DeviceFlowProvider } from './js/data/auth/providers/device-flow.js';

    const logger = createLogger('Main');

    // Initialize console commands (for debugging)
    consoleCommands.initialize();

    // Global auth references
    let tokenStore = null;
    let edgeClient = null;
    let googleAccountAuth = null;
    let isAuthenticated = false;

    // UI Helper functions
    function updateLoginStatus(message) {
      document.getElementById('login-status').textContent = message;
    }

    function updateLoginButton(text, enabled = true, showSpinner = false) {
      const button = document.getElementById('login-button');
      button.disabled = !enabled;
      button.innerHTML = showSpinner
        ? `<span class="spinner"></span><span>${text}</span>`
        : `<span>${text}</span>`;
    }

    function showLoginError(message) {
      const errorEl = document.getElementById('login-error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function hideLoginScreen() {
      document.getElementById('oauth-login-screen').classList.add('hidden');
      document.getElementById('dashboard-container').classList.add('visible');
    }

    // Initialize authentication
    async function initializeAuth() {
      try {
        logger.info('üîê Initializing authentication...');
        updateLoginStatus('Setting up authentication system...');

        // 1. Initialize EdgeClient FIRST
        // Constructor automatically loads JWT from localStorage if available
        edgeClient = new EdgeClient();
        if (edgeClient.jwtToken) {
          logger.success('EdgeClient initialized - JWT loaded from localStorage');
        } else {
          logger.success('EdgeClient initialized - no JWT found');
        }

        // 2. Initialize TokenStore WITH EdgeClient
        tokenStore = new TokenStore();
        await tokenStore.initialize(edgeClient);
        logger.success('TokenStore initialized');

        // 3. Detect platform and initialize appropriate OAuth providers
        const platform = getPlatformDetector();
        const isFireTV = platform.getPlatformDescription().includes('Fire TV');

        let webOAuthProvider = null;
        let deviceFlowProvider = null;

        if (isFireTV) {
          logger.info('Fire TV detected - creating Device Flow provider');
          deviceFlowProvider = new DeviceFlowProvider();
          logger.success('DeviceFlowProvider created');
        } else {
          logger.info('Desktop/Mobile detected - creating Web OAuth provider');
          webOAuthProvider = new WebOAuthProvider();
          logger.success('WebOAuthProvider created');
        }

        // 4. Initialize GoogleAccountAuth with providers, edgeClient, and tokenStore
        // This will also check for OAuth callbacks and return the result
        googleAccountAuth = new GoogleAccountAuth(webOAuthProvider, deviceFlowProvider, edgeClient, tokenStore);
        const oauthResult = await googleAccountAuth.initialize();
        logger.success('GoogleAccountAuth initialized with JWT bootstrap capability');

        // 5. Check if OAuth callback returned a user
        if (oauthResult && oauthResult.success && oauthResult.user) {
          logger.success('OAuth callback detected! User authenticated', {
            email: oauthResult.user.email
          });

          // GoogleAccountAuth.initialize() already processed the OAuth callback
          // But we need to trigger the full sign-in flow to bootstrap JWT
          updateLoginStatus('Completing authentication...');

          try {
            // This will bootstrap JWT and store tokens
            // GoogleAccountAuth already has the OAuth result from init()
            const user = googleAccountAuth.getUser();

            if (user) {
              // User was set during init, now we need JWT bootstrap
              // Manually trigger bootstrap since we already have tokens
              logger.info('Bootstrapping JWT from OAuth callback...');

              const jwtResult = await googleAccountAuth.bootstrapJWT(
                edgeClient,
                oauthResult.tokens.access_token
              );

              logger.success('JWT bootstrap complete', {
                userId: jwtResult.user?.id,
                tier: jwtResult.access?.tier
              });

              // CRITICAL: Update TokenStore with JWT-authenticated EdgeClient
              tokenStore.edgeClient = edgeClient;
              logger.debug('TokenStore updated with JWT-authenticated EdgeClient');

              // Determine which provider was used for the OAuth callback
              // Use device-aware account type to prevent overwriting wrong account
              const usedProvider = googleAccountAuth.activeProvider;
              const isDeviceFlow = usedProvider === deviceFlowProvider;
              const accountType = isDeviceFlow ? 'primary-tv' : 'primary';

              logger.debug('Storing OAuth callback tokens', {
                accountType,
                isDeviceFlow,
                provider: isDeviceFlow ? 'device_flow' : 'web_oauth'
              });

              // Store tokens with dual-write (now EdgeClient has JWT!)
              await tokenStore.storeAccountTokens('google', accountType, {
                access_token: oauthResult.tokens.access_token,
                refresh_token: oauthResult.tokens.refresh_token,
                expires_at: new Date(Date.now() + (oauthResult.tokens.expires_in * 1000)).toISOString(),
                scopes: oauthResult.tokens.scope?.split(' ') || [],
                email: oauthResult.user.email,
                display_name: oauthResult.user.name,
                provider_info: {
                  type: isDeviceFlow ? 'device_flow' : 'web_oauth',
                  auth_method: oauthResult.user.authMethod,
                  client_id: usedProvider?.config?.client_id || 'unknown'
                }
              });

              logger.success('OAuth tokens stored to Supabase (dual-write)');

              updateLoginStatus(`Welcome, ${user.name}!`);
              isAuthenticated = true;

              // Hide login screen and proceed to dashboard
              setTimeout(() => {
                hideLoginScreen();
                initializeCore();
              }, 1000);

              return true;
            }
          } catch (error) {
            logger.error('JWT bootstrap failed during OAuth callback', error);
            showLoginError(`Authentication error: ${error.message}`);
            return false;
          }
        }

        // 6. Try to restore session from JWT (already loaded by EdgeClient)
        logger.info('Checking for stored JWT...');
        updateLoginStatus('Checking for saved session...');

        if (edgeClient.jwtToken) {
          try {
            logger.info('Found JWT, checking if valid and refreshing if needed');

            // Check if JWT is expired or expiring soon (< 60 min remaining)
            if (edgeClient.isJWTExpired(60)) {
              logger.info('JWT expired or expiring soon, refreshing...');
              updateLoginStatus('Refreshing your session...');

              try {
                await edgeClient.refreshJWT();
                logger.success('JWT refreshed successfully');
              } catch (refreshError) {
                logger.error('JWT refresh failed', refreshError);
                // Clear invalid JWT
                edgeClient.clearJWT();
                logger.info('JWT cleared - user must re-authenticate');
                throw new Error('Session expired - please sign in again');
              }
            }

            // JWT is valid! Restore session
            updateLoginStatus('Restoring your session...');

            logger.success('Session restored from JWT', {
              userId: edgeClient.jwtUserId,
              email: edgeClient.jwtUserEmail
            });

            // Update TokenStore with authenticated EdgeClient
            tokenStore.edgeClient = edgeClient;

            // Set user in GoogleAccountAuth
            // Note: We don't have full user details (name, picture) from JWT
            // Those will be loaded when needed
            googleAccountAuth.user = {
              id: edgeClient.jwtUserId,
              email: edgeClient.jwtUserEmail,
              name: edgeClient.jwtUserEmail.split('@')[0], // Use email prefix as fallback
              picture: null,
              provider: 'google',
              authMethod: 'jwt_restoration',
              signedInAt: Date.now()
            };

            updateLoginStatus(`Welcome back!`);
            isAuthenticated = true;

            setTimeout(() => {
              hideLoginScreen();
              initializeCore();
            }, 500);

            return true;

          } catch (sessionError) {
            logger.error('Session restoration failed', sessionError);
            // Fall through to show login button
          }
        } else {
          logger.info('No JWT found - user must sign in');
        }

        // 7. No authentication - show sign in button
        logger.info('No user authenticated');
        updateLoginStatus('Ready to sign in');
        updateLoginButton('Sign in with Google', true, false);

        // Attach sign-in handler
        document.getElementById('login-button').onclick = async () => {
          try {
            if (isFireTV) {
              updateLoginButton('Starting Device Flow...', false, true);
              updateLoginStatus('Follow instructions on screen...');

              const result = await googleAccountAuth.signIn({ useDeviceFlow: true });

              if (result && result.email) {
                // Store tokens
                const tokenData = {
                  access_token: result.googleAccessToken || googleAccountAuth.getAccessToken(),
                  refresh_token: deviceFlowProvider.getRefreshToken(),
                  expires_at: new Date(Date.now() + 3600000).toISOString(),
                  scopes: [],
                  email: result.email,
                  display_name: result.name,
                  provider_info: {
                    type: 'device_flow',
                    auth_method: result.authMethod,
                    client_id: deviceFlowProvider.config.client_id
                  }
                };

                await tokenStore.storeAccountTokens('google', 'primary', tokenData);
                logger.success('Device Flow tokens stored');

                updateLoginStatus(`Welcome, ${result.name}!`);
                isAuthenticated = true;

                setTimeout(() => {
                  hideLoginScreen();
                  initializeCore();
                }, 1000);
              }
            } else {
              updateLoginButton('Redirecting to Google...', false, true);
              await googleAccountAuth.signIn();
            }
          } catch (error) {
            logger.error('Sign-in failed', error);
            showLoginError(`Sign-in failed: ${error.message}`);
            updateLoginButton('Sign in with Google', true, false);
          }
        };

        return false;

      } catch (error) {
        logger.error('Auth initialization failed', error);
        showLoginError(`Authentication error: ${error.message}`);
        updateLoginButton('Retry', true, false);

        document.getElementById('login-button').onclick = () => {
          window.location.reload();
        };

        return false;
      }
    }

    // Initialize core components
    async function initializeCore() {
      try {
        logger.info('Starting core initialization...');

        // Initialize AppStateManager
        await AppStateManager.initialize();
        logger.success('AppStateManager initialized');

        // Initialize InputHandler
        await InputHandler.initialize();
        logger.success('InputHandler initialized');

        // Initialize ActionRouter
        await ActionRouter.initialize();
        logger.success('ActionRouter initialized');

        // Initialize WidgetMessenger
        await WidgetMessenger.initialize();
        logger.success('WidgetMessenger initialized');

        // Initialize Dashboard module
        await Dashboard.initialize();
        logger.success('Dashboard module initialized');

        // Register Dashboard with ActionRouter
        ActionRouter.registerModule('dashboard', DashboardInputHandler);
        logger.success('Dashboard module registered with ActionRouter');

        // Set Dashboard as active module
        AppStateManager.setCurrentModule('dashboard');
        logger.success('Dashboard set as current module');

        // Activate Dashboard
        Dashboard.activate();
        logger.success('Dashboard activated');

        // Detect platform
        const platform = getPlatformDetector();
        logger.info('Platform detected', { platform: platform.getPlatformDescription() });

        logger.success('Core initialization complete');

      } catch (error) {
        logger.error('Core initialization failed', error);
      }
    }

    // Initialize on page load - start with auth
    window.addEventListener('DOMContentLoaded', initializeAuth);
  </script>
</body>
</html>
