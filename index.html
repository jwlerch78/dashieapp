<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashie Dashboard</title>

  <!-- CSS Variables -->
  <link rel="stylesheet" href="./css/core/variables.css">

  <!-- Dashboard Module CSS -->
  <link rel="stylesheet" href="./css/modules/dashboard.css">

  <!-- Settings Module CSS -->
  <link rel="stylesheet" href="./css/modules/settings.css">

  <!-- Modals Module CSS -->
  <link rel="stylesheet" href="./css/modules/modals.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #1a1a1a;
      color: #ffffff;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* OAuth Login Screen */
    #oauth-login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.3s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    #oauth-login-screen.hidden {
      display: none; /* Actually remove from layout */
    }

    /* Sign-in modal styling - matches legacy auth-ui.css */
    .sign-in-modal {
      background: #FCFCFF !important;
      border-radius: 12px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      color: #424242 !important;
    }

    .dashie-logo-signin {
      width: 150px !important;
      height: auto;
      margin: 0 auto 20px auto;
      display: block;
    }

    .sign-in-header h2 {
      color: #424242 !important;
      margin: 0 0 10px 0;
      font-size: 28px;
      font-weight: bold;
    }

    .sign-in-header p {
      color: #616161 !important;
      margin: 0 0 30px 0;
      font-size: 16px;
      font-style: italic;
    }

    .privacy-notice {
      color: #616161 !important;
      margin: 30px 0 5px 0 !important;
      font-size: 16px !important;
      font-style: normal !important;
    }

    .sign-in-content {
      margin: 30px 0;
    }

    .sign-in-footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #E5E5E5;
    }

    /* Sign-in button styling - matches legacy */
    .signin-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 12px 20px;
      background: white;
      color: #5f6368;
      border: 1px solid #dadce0;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
      outline: none;
    }

    .signin-button:hover {
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      background: #f8f9fa;
      transform: translateY(-1px);
    }

    .signin-button.primary {
      background: #1a73e8;
      color: white;
      border: 1px solid #1a73e8;
    }

    .signin-button.primary:hover {
      background: #1557b0;
      border: 1px solid #1557b0;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }

    .signin-button.secondary {
      background: white;
      color: #5f6368;
      border: 1px solid #dadce0;
    }

    .signin-button.secondary:hover {
      background: #f8f9fa;
      border: 1px solid #bdc1c6;
    }

    .signin-button:disabled {
      background: rgba(189, 193, 198, 0.3);
      color: rgba(95, 99, 104, 0.5);
      cursor: not-allowed;
      transform: none;
    }

    /* Orange focus for D-pad/keyboard navigation */
    .signin-button:focus {
      outline: 3px solid #ffaa00 !important;
      outline-offset: 2px;
      transform: scale(1.02) !important;
      box-shadow: 0 0 15px rgba(255, 170, 0, 0.5) !important;
    }

    .login-status {
      background: rgba(189, 193, 198, 0.1);
      border: 1px solid rgba(189, 193, 198, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 10px;
      font-size: 14px;
      color: #616161;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .login-error {
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #d32f2f;
      color: #d32f2f;
      margin-top: 16px;
      font-size: 14px;
    }

    /* External site info styling - inside the modal box */
    .site-info-external {
      text-align: center;
      margin-top: 20px;
    }

    .site-info-external p {
      color: #9e9e9e !important;
      font-size: 14px;
      margin: 5px 0;
    }

    .prod-site-link {
      color: #1a73e8 !important;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
      outline: none;
      display: inline-block;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .prod-site-link:hover {
      border-bottom-color: #1a73e8;
      background: rgba(26, 115, 232, 0.1);
    }

    /* TV/Fire TV focus styling for link */
    .prod-site-link:focus {
      outline: 3px solid #ffaa00 !important;
      outline-offset: 2px;
      transform: scale(1.02) !important;
      box-shadow: 0 0 15px rgba(255, 170, 0, 0.5) !important;
    }

    /* Redirect modal styling */
    .redirect-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .redirect-modal {
      background: #FCFCFF;
      border-radius: 12px;
      padding: 30px;
      max-width: 450px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      color: #424242;
    }

    .redirect-modal h3 {
      color: #424242;
      margin: 0 0 15px 0;
      font-size: 24px;
      font-weight: bold;
    }

    .redirect-modal p {
      color: #616161;
      margin: 0 0 15px 0;
      font-size: 16px;
      line-height: 1.4;
    }

    .redirect-modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 25px;
    }

    .redirect-modal-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px 20px;
      border: 1px solid #dadce0;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      outline: none;
    }

    .redirect-modal-button.primary {
      background: #1a73e8;
      color: white;
      border: 1px solid #1a73e8;
    }

    .redirect-modal-button.primary:hover {
      background: #1557b0;
      border: 1px solid #1557b0;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }

    .redirect-modal-button.secondary {
      background: white;
      color: #5f6368;
      border: 1px solid #dadce0;
    }

    .redirect-modal-button.secondary:hover {
      background: #f8f9fa;
      border: 1px solid #bdc1c6;
    }

    .redirect-modal-button.cancel {
      background: #f8f9fa;
      color: #424242;
      border: 1px solid #dadce0;
    }

    .redirect-modal-button.cancel:hover {
      background: #e8eaed;
      border: 1px solid #bdc1c6;
    }

    /* TV focus for redirect modal buttons */
    .redirect-modal-button:focus {
      outline: 3px solid #ffaa00 !important;
      outline-offset: 2px;
      transform: scale(1.02) !important;
      box-shadow: 0 0 15px rgba(255, 170, 0, 0.5) !important;
    }

    .redirect-modal-divider {
      margin: 20px 0;
      height: 1px;
      background: #e0e0e0;
    }

    .redirect-modal-always-section {
      margin-top: 15px;
    }

    .dashboard-container {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .dashboard-container.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- OAuth Login Screen -->
  <div id="oauth-login-screen">
    <div class="sign-in-modal">
      <img src="./artwork/Dashie_Full_Logo_Orange_Transparent.png" alt="Dashie" class="dashie-logo-signin">

      <div class="sign-in-header">
        <h2>Welcome to Dashie!</h2>
        <p>Helping active families manage the chaos</p>
      </div>

      <div class="sign-in-content">
        <div class="login-status" id="login-status">
          Initializing authentication system...
        </div>

        <button class="signin-button secondary" id="login-button" disabled tabindex="1">
          <span class="spinner"></span>
          <span>Loading...</span>
        </button>

        <button class="signin-button secondary" id="exit-app-btn" tabindex="2">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
          </svg>
          Exit
        </button>

        <div class="login-error" id="login-error" style="display: none;"></div>

        <p class="privacy-notice">Your data stays private and secure</p>
      </div>

      <div class="sign-in-footer">
        <!-- Site info inside the modal box -->
        <div class="site-info-external" id="site-info-external">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Container (hidden until authenticated) -->
  <div id="dashboard-container" class="dashboard-container">
    <!-- Dashboard renders here full-screen -->
  </div>

  <!-- Core JavaScript Modules -->
  <script type="module">
    import { createLogger } from './js/utils/logger.js';
    import consoleCommands from './js/utils/console-commands.js';
    import AppComms from './js/core/app-comms.js';
    import AppStateManager from './js/core/app-state-manager.js';
    import InputHandler from './js/core/input-handler.js';
    import ActionRouter from './js/core/action-router.js';
    import WidgetMessenger from './js/core/widget-messenger.js';
    import { getPlatformDetector } from './js/utils/platform-detector.js';
    import Dashboard from './js/modules/Dashboard/dashboard.js';
    import DashboardInputHandler from './js/modules/Dashboard/dashboard-input-handler.js';
    import Settings from './js/modules/Settings/settings.js';
    import modals from './js/modules/Modals/modals.js';
    import { createModalNavigation } from './js/utils/modal-navigation-manager.js';

    // Phase 3 - Auth imports (orchestration layer)
    import { sessionManager } from './js/data/auth/orchestration/session-manager.js';
    import { AuthCoordinator } from './js/data/auth/orchestration/auth-coordinator.js';

    // Phase 3.5 - Widget imports
    import { initializeWidgetDataManager } from './js/core/widget-data-manager.js';
    import { initializeCalendarService } from './js/data/services/calendar-service.js';

    // Phase 4 - Settings import
    import settingsService from './js/data/services/settings-service.js';

    // UI Layer imports
    import themeApplier from './js/ui/theme-applier.js';

    const logger = createLogger('Main');

    // Initialize console commands (for debugging)
    consoleCommands.initialize();

    // Global auth references
    const authCoordinator = new AuthCoordinator();
    let isAuthenticated = false;

    // Expose sessionManager globally for console commands
    window.sessionManager = sessionManager;

    // UI Helper functions
    function updateLoginStatus(message) {
      document.getElementById('login-status').textContent = message;
    }

    function updateLoginButton(text, enabled = true, showSpinner = false) {
      const button = document.getElementById('login-button');
      button.disabled = !enabled;

      const googleLogo = `
        <svg class="google-logo" width="20" height="20" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
      `;

      if (showSpinner) {
        button.innerHTML = `<span class="spinner"></span><span>${text}</span>`;
      } else if (text.includes('Sign in') || text.includes('Retry')) {
        button.innerHTML = `${googleLogo}<span>${text}</span>`;
      } else {
        button.innerHTML = `<span>${text}</span>`;
      }
    }

    function showLoginError(message) {
      const errorEl = document.getElementById('login-error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function hideLoginScreen() {
      document.getElementById('oauth-login-screen').classList.add('hidden');
      document.getElementById('dashboard-container').classList.add('visible');

      // Clean up login screen input handler
      if (window._loginInputHandler) {
        document.removeEventListener('keydown', window._loginInputHandler, true);
        delete window._loginInputHandler;
        logger.debug('Login screen input handler removed');
      }

      // Unregister login screen from modal manager
      if (window.dashieModalManager) {
        window.dashieModalManager.unregisterModal();
        logger.debug('Login screen unregistered from modal manager');
      }
    }

    // Populate site info (dev vs prod link)
    function populateSiteInfo() {
      const hostname = window.location.hostname;
      const isDev = hostname.includes('dev') || hostname === 'localhost' || hostname.startsWith('localhost');
      const platform = getPlatformDetector();
      const platformDesc = platform.getPlatformDescription();

      const siteInfoDiv = document.getElementById('site-info-external');
      if (siteInfoDiv) {
        if (isDev) {
          siteInfoDiv.innerHTML = `
            <p>Logging into Dev Site &nbsp;&nbsp;|&nbsp;&nbsp; ${platformDesc}</p>
            <p><a href="#" id="site-switch-link" class="prod-site-link" tabindex="3">Go to production site</a></p>
          `;
        } else {
          siteInfoDiv.innerHTML = `
            <p>Logging into Production Site &nbsp;&nbsp;|&nbsp;&nbsp; ${platformDesc}</p>
            <p><a href="#" id="site-switch-link" class="prod-site-link" tabindex="3">Go to development site</a></p>
          `;
        }

        // Add event listener (will implement redirect modal later)
        const siteLink = document.getElementById('site-switch-link');
        if (siteLink) {
          siteLink.addEventListener('click', (e) => {
            e.preventDefault();
            logger.info('Site switch clicked - redirect modal not implemented yet');
          });

          siteLink.addEventListener('keydown', (e) => {
            if (e.keyCode === 13 || e.keyCode === 23 || e.key === 'Enter') {
              e.preventDefault();
              e.stopPropagation();
              logger.info('Site switch selected - redirect modal not implemented yet');
            }
          });
        }
      }
    }

    // Setup D-pad navigation for login screen using modal navigation manager
    function setupLoginNavigation() {
      const loginScreen = document.getElementById('oauth-login-screen');
      const buttons = ['login-button', 'exit-app-btn', 'site-switch-link'];

      // Use the same modal navigation system as modals/settings (cookie-cutter approach)
      createModalNavigation(loginScreen, buttons, {
        initialFocus: 0, // Focus login button first
        onEscape: () => {
          // Escape should exit the program
          logger.info('Escape pressed on login screen - exiting');
          window.close();
        }
      });

      logger.debug('Login screen navigation set up with modal navigation manager', {
        hasGlobalManager: !!window.dashieModalManager,
        isModalActive: window.dashieModalManager?.hasActiveModal(),
        focusableCount: window.dashieModalManager?.focusableElements?.length,
        debugInfo: window.dashieModalManager?.getDebugInfo()
      });

      // IMPORTANT: Set up temporary keyboard handler for login screen
      // This handles D-pad input BEFORE ActionRouter is initialized
      const handleLoginInput = (e) => {
        // Arrow keys
        const keyMap = {
          38: 'up',    // Up arrow
          40: 'down',  // Down arrow
          37: 'left',  // Left arrow
          39: 'right', // Right arrow
          13: 'enter', // Enter
          27: 'escape' // Escape
        };

        const action = keyMap[e.keyCode];
        if (action && window.dashieModalManager) {
          const handled = window.dashieModalManager.handleAction(action);
          if (handled) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      };

      // Add keyboard listener
      document.addEventListener('keydown', handleLoginInput, true);

      // Store reference for cleanup
      window._loginInputHandler = handleLoginInput;

      logger.debug('Login screen temporary input handler set up');
    }

    // Initialize authentication (using orchestration layer)
    async function initializeAuth() {
      try {
        logger.info('🔐 Initializing authentication...');
        updateLoginStatus('Setting up authentication system...');

        // Populate site info
        populateSiteInfo();

        // Initialize SessionManager (handles entire auth flow)
        const result = await sessionManager.initialize(authCoordinator);

        // Check authentication result
        if (result.authenticated) {
          const user = sessionManager.getUser();

          if (result.oauthCallback) {
            // OAuth callback flow
            updateLoginStatus(`Welcome, ${user.name || user.email}!`);
          } else {
            // Session restoration flow
            updateLoginStatus(`Welcome back!`);
          }

          isAuthenticated = true;

          // Hide login screen and proceed to dashboard
          setTimeout(() => {
            hideLoginScreen();
            initializeCore();
          }, result.oauthCallback ? 1000 : 500);

          return true;
        }

        // Not authenticated - show sign in button
        logger.info('No user authenticated');
        document.getElementById('login-status').style.display = 'none'; // Hide status box
        updateLoginButton('Sign in with Google', true, false);

        // Setup D-pad navigation
        setupLoginNavigation();

        // Attach sign-in handler
        const isFireTV = authCoordinator.isFireTVPlatform();
        const loginButton = document.getElementById('login-button');
        const exitButton = document.getElementById('exit-app-btn');

        const handleSignIn = async () => {
          try {
            const buttonText = isFireTV ? 'Starting Device Flow...' : 'Redirecting to Google...';
            updateLoginButton(buttonText, false, true);
            updateLoginStatus(isFireTV ? 'Follow instructions on screen...' : 'Redirecting...');

            const signInResult = await sessionManager.signIn({ useDeviceFlow: isFireTV });

            // Check for redirect (web OAuth)
            if (signInResult && signInResult.redirected) {
              logger.debug('OAuth redirect initiated');
              return;
            }

            // Sign-in successful
            if (signInResult && signInResult.email) {
              updateLoginStatus(`Welcome, ${signInResult.name || signInResult.email}!`);
              isAuthenticated = true;

              setTimeout(() => {
                hideLoginScreen();
                initializeCore();
              }, 1000);
            }

          } catch (error) {
            logger.error('Sign-in failed', error);
            showLoginError(`Sign-in failed: ${error.message}`);
            updateLoginButton('Sign in with Google', true, false);
          }
        };

        loginButton.onclick = handleSignIn;

        // Add keyboard/D-pad handler
        loginButton.addEventListener('keydown', (e) => {
          if (e.keyCode === 13 || e.keyCode === 23 || e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            if (!loginButton.disabled) {
              handleSignIn();
            }
          }
        });

        // Auto-focus button when enabled (for D-pad navigation)
        const observer = new MutationObserver(() => {
          if (!loginButton.disabled) {
            setTimeout(() => {
              loginButton.focus();
              logger.debug('Auto-focused login button');
            }, 100);
            observer.disconnect();
          }
        });
        observer.observe(loginButton, { attributes: true, attributeFilter: ['disabled'] });

        // Setup Exit button handler
        exitButton.addEventListener('click', (e) => {
          e.preventDefault();
          logger.info('Exit button clicked');
          window.close(); // Try to close window (works in some environments)
        });

        exitButton.addEventListener('keydown', (e) => {
          if (e.keyCode === 13 || e.keyCode === 23 || e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            logger.info('Exit button selected');
            window.close();
          }
        });

        return false;

      } catch (error) {
        logger.error('Auth initialization failed', error);
        showLoginError(`Authentication error: ${error.message}`);
        updateLoginButton('Retry', true, false);

        document.getElementById('login-button').onclick = () => {
          window.location.reload();
        };

        return false;
      }
    }

    // Initialize data services (EdgeClient, SettingsService, CalendarService)
    async function initializeDataServices() {
      try {
        logger.info('Initializing data services...');

        // Get EdgeClient from SessionManager
        const edgeClient = sessionManager.getEdgeClient();

        // Expose edgeClient globally for Settings Store
        window.edgeClient = edgeClient;

        // Initialize SettingsService with EdgeClient for database operations
        settingsService.setEdgeClient(edgeClient);
        logger.success('SettingsService initialized with EdgeClient');

        // Initialize CalendarService
        const calendarService = initializeCalendarService(edgeClient);
        logger.success('CalendarService initialized');

        logger.success('Data services initialized');

      } catch (error) {
        logger.error('Failed to initialize data services', error);
      }
    }

    // Initialize widgets AFTER theme is applied
    async function initializeWidgets() {
      try {
        logger.info('Initializing widgets (theme should already be applied)...');

        // Initialize WidgetDataManager
        const widgetDataManager = initializeWidgetDataManager();
        logger.success('WidgetDataManager initialized');

        // Register widget iframes
        // IMPORTANT: Widgets load AFTER Settings applies theme, so they get correct theme from localStorage
        const clockIframe = document.getElementById('widget-clock');
        const headerIframe = document.getElementById('widget-header');

        if (clockIframe) {
          widgetDataManager.registerWidget('clock', clockIframe);
          logger.info('Clock widget registered');
        }

        if (headerIframe) {
          widgetDataManager.registerWidget('header', headerIframe);
          logger.info('Header widget registered');
        }

        logger.success('Widgets initialized with correct theme');

      } catch (error) {
        logger.error('Failed to initialize widgets', error);
      }
    }

    // Initialize core components
    async function initializeCore() {
      try {
        logger.info('Starting core initialization...');

        // Initialize AppStateManager
        await AppStateManager.initialize();
        logger.success('AppStateManager initialized');

        // Make themeApplier globally accessible
        window.themeApplier = themeApplier;
        logger.info('ThemeApplier exposed globally');

        // STEP 1: Initialize data services (EdgeClient + SettingsService)
        await initializeDataServices();

        // STEP 2: Initialize Settings (loads from database, applies theme to localStorage)
        await Settings.initialize();
        logger.success('Settings initialized (theme loaded from database and applied)');

        // STEP 3: NOW initialize widgets (they will load with correct theme from localStorage)
        await initializeWidgets();

        // Initialize InputHandler
        await InputHandler.initialize();
        logger.success('InputHandler initialized');

        // Initialize ActionRouter
        await ActionRouter.initialize();
        logger.success('ActionRouter initialized');

        // Initialize WidgetMessenger
        await WidgetMessenger.initialize();
        logger.success('WidgetMessenger initialized');

        // Initialize Dashboard module
        await Dashboard.initialize();
        logger.success('Dashboard module initialized');

        // Register Dashboard with ActionRouter
        ActionRouter.registerModule('dashboard', DashboardInputHandler);
        logger.success('Dashboard module registered with ActionRouter');

        // Register Settings with ActionRouter
        ActionRouter.registerModule('settings', Settings.getInputHandler());
        logger.success('Settings module registered with ActionRouter');

        // Expose Settings globally for testing
        window.Settings = Settings;

        // Initialize Modals module
        await modals.initialize();
        logger.success('Modals module initialized');

        // Register Modals with ActionRouter
        ActionRouter.registerModule('modals', modals);
        logger.success('Modals module registered with ActionRouter');

        // Set Dashboard as active module
        AppStateManager.setCurrentModule('dashboard');
        logger.success('Dashboard set as current module');

        // Activate Dashboard
        Dashboard.activate();
        logger.success('Dashboard activated');

        // Detect platform
        const platform = getPlatformDetector();
        logger.info('Platform detected', { platform: platform.getPlatformDescription() });

        logger.success('Core initialization complete');

      } catch (error) {
        logger.error('Core initialization failed', error);
      }
    }

    // Initialize on page load - start with auth
    window.addEventListener('DOMContentLoaded', initializeAuth);
  </script>
</body>
</html>
