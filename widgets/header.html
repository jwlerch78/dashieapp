<!-- header.html: Header Widget -->
/* UPDATED: Family name management with "The [Name] Family" formatting */

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashie Header</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      color: white;
      margin: 0;
      padding: 20px;
      text-align: center;
      background: transparent;
      font-weight: 300;
    }

    #family-name {
      font-size: 2.5em;
      font-weight: bold;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      letter-spacing: 1px;
    }

    .date-info {
      font-size: 1.2em;
      margin-top: 15px;
      opacity: 0.9;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <div id="family-name">The Dashie Family</div>
  <div class="date-info" id="date-display"></div>

  <script>
    // UPDATED: Family name management with "The [Name] Family" formatting
    function updateFamilyName(familyName) {
      const element = document.getElementById('family-name');
      if (element && familyName && familyName.trim()) {
        // Format as "The [Name] Family" - but handle cases where user included "The" or "Family"
        let cleanName = familyName.trim();
        
        // Remove "The" prefix if user included it
        if (cleanName.toLowerCase().startsWith('the ')) {
          cleanName = cleanName.substring(4).trim();
        }
        
        // Remove "Family" suffix if user included it
        if (cleanName.toLowerCase().endsWith(' family')) {
          cleanName = cleanName.substring(0, cleanName.length - 7).trim();
        }
        
        // Format the final display
        element.textContent = `The ${cleanName} Family`;
        console.log(`ðŸ“„ Header: Family name updated to "The ${cleanName} Family"`);
      } else {
        // Fallback to default
        element.textContent = 'The Dashie Family';
        console.log('ðŸ“„ Header: Using default family name');
      }
    }

    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      
      const dateStr = now.toLocaleDateString('en-US', options);
      document.getElementById('date-display').textContent = dateStr;
    }

    // UPDATED: Enhanced initialization with multiple family name loading strategies
    function initializeHeader() {
      console.log('ðŸ“„ Header widget initializing...');
      
      // Update date immediately and then every minute
      updateDateTime();
      setInterval(updateDateTime, 60000);
      
      // Strategy 1: Request family name from parent settings system
      console.log('ðŸ“„ Requesting family name from parent...');
      try {
        window.parent.postMessage({
          type: 'request-family-name',
          widget: 'header'
        }, '*');
      } catch (error) {
        console.warn('ðŸ“„ Could not request from parent:', error);
      }
      
      // Strategy 2: Check if parent has settings available directly
      setTimeout(() => {
        try {
          if (window.parent.dashieAuth && window.parent.dashieAuth.isAuthenticated()) {
            // Try to get settings directly from parent
            const settingsManager = window.parent.settingsManager;
            if (settingsManager && settingsManager.getSetting) {
              const familyName = settingsManager.getSetting('family.familyName');
              if (familyName) {
                updateFamilyName(familyName);
                console.log('ðŸ“„ Got family name directly from parent settings');
                return;
              }
            }
          }
        } catch (error) {
          console.warn('ðŸ“„ Direct parent access failed:', error);
        }
        
        // Strategy 3: Try localStorage as fallback
        try {
          const savedSettings = localStorage.getItem('dashie-settings');
          if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            if (settings.family && settings.family.familyName) {
              updateFamilyName(settings.family.familyName);
              console.log('ðŸ“„ Got family name from localStorage');
              return;
            }
          }
        } catch (error) {
          console.warn('ðŸ“„ localStorage fallback failed:', error);
        }
        
        console.log('ðŸ“„ Using default family name');
      }, 1000);
      
      // Notify parent that header is ready
      try {
        window.parent.postMessage({
          type: 'widget-ready',
          widget: 'header'
        }, '*');
      } catch (error) {
        console.warn('ðŸ“„ Could not notify parent of readiness:', error);
      }
    }

    // UPDATED: Enhanced message listener for family name updates
    window.addEventListener('message', (event) => {
      if (event.data) {
        console.log('ðŸ“„ Header received message:', event.data.type);
        
        switch (event.data.type) {
          case 'family-name-response':
            if (event.data.familyName) {
              updateFamilyName(event.data.familyName);
            }
            break;
            
          case 'family-name-updated':
            if (event.data.familyName) {
              updateFamilyName(event.data.familyName);
              console.log('ðŸ“„ Family name updated from settings change');
            }
            break;
            
          case 'theme-change':
            // Handle theme changes if needed
            console.log('ðŸ“„ Theme change received:', event.data.theme);
            break;
            
          default:
            // console.log('ðŸ“„ Unhandled message type:', event.data.type);
            break;
        }
      }
    });

    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeHeader);
    } else {
      initializeHeader();
    }
  </script>
</body>
</html>
